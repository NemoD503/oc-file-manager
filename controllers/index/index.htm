<div class="scoreboard">
<?php

use System\Classes\PluginManager;
use Backend\Models\UserPreferences;

$preferences = UserPreferences::forUser()->get('backend::backend.preferences');

function fm_stat($folder = 'uploads/public')
{
    $attr['size'] = $attr['files'] = $attr['folders'] = 0;
    $attr['audio'] = $attr['archive'] = $attr['code'] = $attr['doc'] = $attr['image'] = $attr['other'] = $attr['prezi'] = $attr['table'] = $attr['text'] = $attr['video'] = 0;

    $elementents = scandir($folder);
    foreach ($elementents as $element) {
        if ($element != '.' && $element != '..' && $element != '.quarantine' && $element != '.tmb') {
            if (filetype($folder.'/'.$element) == 'dir') {
                $value = fm_stat($folder.'/'.$element);
                $attr['size'] += $value['size'];
                $attr['files'] += $value['files'];
                $attr['folders'] += $value['folders'] + 1;
                $attr['audio'] += $value['audio'];
                $attr['archive'] += $value['archive'];
                $attr['code'] += $value['code'];
                $attr['doc'] += $value['doc'];
                $attr['image'] += $value['image'];
                $attr['prezi'] += $value['prezi'];
                $attr['table'] += $value['table'];
                $attr['text'] += $value['text'];
                $attr['video'] += $value['video'];
            }

            else {
                $attr['size'] += filesize($folder.'/'.$element);
                $attr['files']++;
                $attr[fm_type(substr(strrchr($element, '.'), 1))]++;
            }
        }
    }

    return $attr;
}

function fm_size($size = 0, $sizename = false)
{
    if ($size > 0) {
        $name = array('B', 'KB', 'MB', 'GB', 'TB', 'PB');
        $common = array('au', 'bn', 'bw', 'ch', 'cn', 'do', 'eg', 'gt', 'hk', 'hn', 'ie', 'il', 'in', 'jp', 'ke', 'kp', 'kr', 'lb', 'lk', 'mn', 'mo', 'mt', 'mx', 'my', 'ng', 'ni', 'np', 'nz', 'pa', 'ph', 'pk', 'sg', 'th', 'tw', 'tz', 'ug', 'uk', 'us', 'zw');

        for ($i = 0; $size >= 1024; $i++) {
            $size /= 1024;
            if ($i < 1) $size = round($size, 0);
            else $size = round($size, 1);
        }

        global $preferences;
        if (!in_array($preferences['locale'], $common)) $size = str_replace('.', ',', $size);
        if ($sizename) $size = $name[$i];

        return $size;
    }

    if ($sizename) $size = 'B';
    else $size = 0;

    return $size;
}

function fm_type($extension = 'txt')
{
    $types = array(
        'audio'   => array('aac', 'ac3',  'aif',  'm3a',  'm4a',  'm4b',  'mka',  'mp1', 'mp2',  'mp3',  'ogg', 'oga', 'ram', 'wav', 'wma'),
        'archive' => array('bz2', 'cab',  'gz',   'rar',  'tar',  'tgz',  'zip',  '7z'),
        'code'    => array('css', 'htm',  'html', 'php',  'js',   'c',    'c++'),
        'doc'     => array('doc', 'docx', 'docm', 'dotm', 'odt',  'pdf',  'rtf',  'wp',  'wpd'),
        'image'   => array('bmp', 'gif',  'ico',  'jpg',  'jpeg', 'png',  'psd',  'raw', 'tif',  'tiff'),
        'prezi'   => array('ppt', 'pptx', 'pptm', 'pps',  'ppsx', 'ppsm', 'sldx', 'sldm'),
        'table'   => array('ods', 'xls',  'xlsx', 'xlsm', 'xlsb'),
        'text'    => array('asc', 'csv',  'tsv',  'txt',  'xml'),
        'video'   => array('avi', 'divx', 'dv',   'flv',  'm4v',  'mkv',  'mov',  'mp4', 'mpeg', 'mpg',  'qt',  'rm',  'swf', 'vob', 'wmv')
    );

    foreach ($types as $type => $extensions) if (in_array($extension, $extensions)) return $type;
    return 'other';
}

$stat = fm_stat();

if (PluginManager::instance()->hasPlugin('AnandPatel.WysiwygEditors')):

?>
    <div data-control="toolbar">
        <div class="scoreboard-item title-value">
            <h4><?= e(trans('indikator.filemanager::lang.widget.basic.folders')) ?></h4>
            <p><?= $stat['folders'] ?></p>
            <p class="description"><?= e(trans('indikator.filemanager::lang.widget.pieces')) ?></p>
        </div>
        <div class="scoreboard-item title-value">
            <h4><?= e(trans('indikator.filemanager::lang.widget.basic.files')) ?></h4>
            <p><?= $stat['files'] ?></p>
            <p class="description"><?= e(trans('indikator.filemanager::lang.widget.pieces')) ?></p>
        </div>
        <div class="scoreboard-item title-value">
            <h4><?= e(trans('indikator.filemanager::lang.widget.basic.size')) ?></h4>
            <p><?= fm_size($stat['size']) ?></p>
            <p class="description"><?= fm_size($stat['size'], true) ?></p>
        </div>
        <div class="scoreboard-item control-chart" data-control="chart-bar">
            <ul>
                <li data-color="#95b753"><?= e(trans('indikator.filemanager::lang.widget.type.doc')) ?> <span><?= $stat['doc'] ?></span></li>
                <li data-color="#e5a91a"><?= e(trans('indikator.filemanager::lang.widget.type.table')) ?> <span><?= $stat['table'] ?></span></li>
                <li data-color="#cc3300"><?= e(trans('indikator.filemanager::lang.widget.type.prezi')) ?> <span><?= $stat['prezi'] ?></span></li>
            </ul>
        </div>
        <div class="scoreboard-item control-chart" data-control="chart-bar">
            <ul>
                <li data-color="#95b753"><?= e(trans('indikator.filemanager::lang.widget.type.image')) ?> <span><?= $stat['image'] ?></span></li>
                <li data-color="#e5a91a"><?= e(trans('indikator.filemanager::lang.widget.type.video')) ?> <span><?= $stat['video'] ?></span></li>
                <li data-color="#cc3300"><?= e(trans('indikator.filemanager::lang.widget.type.audio')) ?> <span><?= $stat['audio'] ?></span></li>
            </ul>
        </div>
        <div class="scoreboard-item control-chart" data-control="chart-bar">
            <ul>
                <li data-color="#95b753"><?= e(trans('indikator.filemanager::lang.widget.type.text')) ?> <span><?= $stat['text'] ?></span></li>
                <li data-color="#e5a91a"><?= e(trans('indikator.filemanager::lang.widget.type.archive')) ?> <span><?= $stat['archive'] ?></span></li>
                <li data-color="#cc3300"><?= e(trans('indikator.filemanager::lang.widget.type.code')) ?> <span><?= $stat['code'] ?></span></li>
            </ul>
        </div>
    </div>
    <script type="text/javascript">
    $().ready(function() {
        $('#elfinder').elfinder({
            <?php if ($preferences['locale'] != 'en' && is_file('plugins/anandpatel/wysiwygeditors/public/js/i18n/elfinder.'.$preferences['locale'].'.js')): ?>
            lang: '<?= $preferences['locale'] ?>',
            <? endif; ?>
            url: '<?= URL::action('Barryvdh\Elfinder\ElfinderController@showConnector') ?>'
        }).elfinder('instance');
    });
    </script>
    <div id="elfinder"></div>
<?php else: ?>
    <p><?= e(trans('indikator.filemanager::lang.error.text')) ?> <a href="https://octobercms.com/plugin/anandpatel-wysiwygeditors" target="_blank"><?= e(trans('indikator.filemanager::lang.error.plugin')) ?></a></p>
<?php endif; ?>
</div>